<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<title>Restricted IP Logging and Response - EZProxyWiki</title>
<meta charset="UTF-8" />
<meta name="generator" content="MediaWiki 1.21.0rc5" />
<link rel="shortcut icon" href="https://pluto.potsdam.edu/favicon.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="https://pluto.potsdam.edu/ezproxywiki/opensearch_desc.php" title="EZProxyWiki (en)" />
<link rel="EditURI" type="application/rsd+xml" href="https://pluto.potsdam.edu/ezproxywiki/api.php?action=rsd" />
<link rel="alternate" type="application/atom+xml" title="EZProxyWiki Atom feed" href="https://pluto.potsdam.edu/ezproxywiki/index.php?title=Special:RecentChanges&amp;feed=atom" />
<link rel="stylesheet" href="../load.php%3Fdebug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint%252Cshared%257Cskins.monobook&amp;only=styles&amp;skin=monobook&amp;*.css" />
<!--[if IE 6]><link rel="stylesheet" href="/ezproxywiki/skins/monobook/IE60Fixes.css?303" media="screen" /><![endif]-->
<!--[if IE 7]><link rel="stylesheet" href="/ezproxywiki/skins/monobook/IE70Fixes.css?303" media="screen" /><![endif]--><meta name="ResourceLoaderDynamicStyles" content="" />
<style>a:lang(ar),a:lang(ckb),a:lang(fa),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: ezpwikidb:resourceloader:filter:minify-css:7:bd176711d87effdb3a6ff09c19734297 */</style>

<script src="../load.php%3Fdebug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=monobook&amp;*"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Restricted_IP_Logging_and_Response","wgTitle":"Restricted IP Logging and Response","wgCurRevisionId":5155,"wgArticleId":3436,"wgIsArticle":true,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Documentation"],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Restricted_IP_Logging_and_Response","wgRestrictionEdit":[],"wgRestrictionMove":[]});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function(){mw.user.options.set({"ccmeonemails":0,"cols":80,"date":"default","diffonly":0,"disablemail":0,"disablesuggest":0,"editfont":"default","editondblclick":0,"editsection":1,"editsectiononrightclick":0,"enotifminoredits":0,"enotifrevealaddr":0,"enotifusertalkpages":1,"enotifwatchlistpages":0,"extendwatchlist":0,"externaldiff":0,"externaleditor":0,"fancysig":0,"forceeditsummary":0,"gender":"unknown","hideminor":0,"hidepatrolled":0,"imagesize":2,"justify":0,"math":1,"minordefault":0,"newpageshidepatrolled":0,"nocache":0,"noconvertlink":0,"norollbackdiff":0,"numberheadings":0,"previewonfirst":0,"previewontop":1,"quickbar":5,"rcdays":7,"rclimit":50,"rememberpassword":0,"rows":25,"searchlimit":20,"showhiddencats":0,"showjumplinks":1,"shownumberswatching":1,"showtoc":1,"showtoolbar":1,"skin":"monobook","stubthreshold":0,"thumbsize":2,"underline":2,"uselivepreview":0,"usenewrc":0,"watchcreations":0,"watchdefault":0,"watchdeletion":0,"watchlistdays":3,
"watchlisthideanons":0,"watchlisthidebots":0,"watchlisthideliu":0,"watchlisthideminor":0,"watchlisthideown":0,"watchlisthidepatrolled":0,"watchmoves":0,"wllimit":250,"variant":"en","language":"en","searchNs0":true,"searchNs1":false,"searchNs2":false,"searchNs3":false,"searchNs4":false,"searchNs5":false,"searchNs6":false,"searchNs7":false,"searchNs8":false,"searchNs9":false,"searchNs10":false,"searchNs11":false,"searchNs12":false,"searchNs13":false,"searchNs14":false,"searchNs15":false});;},{},{});mw.loader.implement("user.tokens",function(){mw.user.tokens.set({"editToken":"+\\","patrolToken":false,"watchToken":false});;},{},{});
/* cache key: ezpwikidb:resourceloader:filter:minify-js:7:a02a7fa766593347c4dbb130a7c3803e */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax"]);
}</script>
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Restricted_IP_Logging_and_Response skin-monobook action-view">
<div id="globalWrapper">
<div id="column-content"><div id="content" class="mw-body-primary" role="main">
	<a id="top"></a>
	
	<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">Restricted IP Logging and Response</span></h1>
	<div id="bodyContent" class="mw-body">
		<div id="siteSub">From EZProxyWiki</div>
		<div id="contentSub"></div>
		<div id="jump-to-nav" class="mw-jump">Jump to: <a href="Restricted_IP_Logging_and_Response.html#column-one">navigation</a>, <a href="Restricted_IP_Logging_and_Response.html#searchInput">search</a></div>
		<!-- start content -->
<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><ul><li>Submitted: September 8, 2014
</li><li>Submitted by <a rel="nofollow" class="external text" href="mailto:duane.denham@okstate.edu">Duane Denham</a>, Edmon Low Library, Oklahoma State University
</li></ul>
<blockquote>Caution – The following method has been successfully tested with the Windows implementation of EZproxy, versions 5.1 through 5.6.2.1 and version 5.7.32.  All versions of 5.7 up to and including 5.7.32 contain a known bug (EZPROX-904) that cause a “browser connection error” message to be displayed in the end users browser and will cause EZproxy to restart.   This method has not been tested on the Linux or Solaris implementation of EZproxy however no implementation issues are anticipated as long as the EZproxy version restrictions are observed.</blockquote>
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="Restricted_IP_Logging_and_Response.html#Overview"><span class="tocnumber">1</span> <span class="toctext">Overview</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="Restricted_IP_Logging_and_Response.html#Background_information_and_commentary"><span class="tocnumber">2</span> <span class="toctext">Background information and commentary</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="Restricted_IP_Logging_and_Response.html#How_to_do_it"><span class="tocnumber">3</span> <span class="toctext">How to do it</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="Restricted_IP_Logging_and_Response.html#Step_1_-_Create_a_file_containing_the_restricted_IPs_for_a_particular_response"><span class="tocnumber">3.1</span> <span class="toctext">Step 1 - Create a file containing the restricted IPs for a particular response</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="Restricted_IP_Logging_and_Response.html#Step_2_.E2.80.93_Add_the_following_statements_to_user.txt_as_indicated_in_the_Notes"><span class="tocnumber">3.2</span> <span class="toctext">Step 2 – Add the following statements to user.txt as indicated in the Notes</span></a></li>
</ul>
</li>
</ul>
</td></tr></table>
<h2> <span class="mw-headline" id="Overview">Overview</span></h2>
<p>One of the options available to the EZproxy community to be able to respond to unauthorized access attempts is RejectIP however; the inability of the command to log connection attempts deprives administrators of useful security information.  The following method allows logging of connection attempts in the Audit Log from restricted IP addresses as well as the user id associated with each attempt.
</p><p>This process uses one or more files that contain IP addresses that need to be restricted from accessing EZproxy.  The reason that multiple files might be advantageous is that it allows a granularity in response to a connection attempt from a particular group of addresses.  E.g.  The response to a connection attempt from an address that is restricted due to a technical or administrative reason would likely be different from the response to a connection attempt from an address that has been associated with suspicious activity.
</p>
<h2> <span class="mw-headline" id="Background_information_and_commentary">Background information and commentary</span></h2>
<blockquote>Note:  LDAP, text file and locally defined user accounts in user.txt were the authentication methods used during development.  The infrastructure to test other authentication methods was unavailable.  The following commentary is based on the test results obtained during development and interpretation of certain phrases and syntax structures in the EZproxy documentation.</blockquote>
<p>While not explicitly defined in the EZproxy documentation, there appear to be two classes of user authentication methods.  The first class is sometimes referred to in the documentation as “built-in”.  Examples of this class include:
</p>
<dl><dd>Locally defined accounts in user.txt
</dd><dd>Text file
</dd><dd>FTP
</dd><dd>IMAP
</dd><dd>POP
</dd><dd>Radius
</dd></dl>
<p><br />
The second class is referenced in the "Common Conditions and Actions" section of the EZproxy documentation as "Extended Authentication and Authorization Methods".  Examples of this class include:
</p>
<dl><dd>LDAP
</dd><dd>CAS
</dd><dd>III
</dd><dd>DRA Web2
</dd></dl>
<p><br />
Based on admittedly limited testing, the most distinguishing characteristic between the two methods, at least as it applies to the Restricted IP Logging method, is that authentication methods in the first class appear to execute an implicit “STOP” command after a successful authentication.  Regardless of the actual mechanism, the result is that all attempts to execute “Common Condition” or “Extended Authentication” statements after authentication failed. 
</p><p>Therefore, authentication methods in the second class would be better candidates to implement Restricted IP Logging than methods in the first class.  It may be possible to use methods in the first class but to date I have not found the right arrangement of statements to achieve it.
</p>
<h2> <span class="mw-headline" id="How_to_do_it">How to do it</span></h2>
<h3> <span class="mw-headline" id="Step_1_-_Create_a_file_containing_the_restricted_IPs_for_a_particular_response">Step 1 - Create a file containing the restricted IPs for a particular response</span></h3>
<p>Create a file using the following format.
</p>
<pre>::Common
IFIP ip,ip,ip…&#160;; Set Match = &quot;True&quot;
(repeat line above as needed - see notes)
/Common
</pre>
<p>Save this file in the EZproxy root directory and repeat if you have additional IP/response scenarios.
</p><p>Notes:
</p>
<ul><li>	I keep a few master files of addresses (that have been designated restricted for one reason or another) in a one address per line format so I can easily scan through them in case I receive a query about a particular address.
</li></ul>
<ul><li>	Since the master files are not directly usable in the IFIP lines, I created RestrictedIPparser.exe to automate the creation and maintenance of the production files used in Step 1.  <a rel="nofollow" class="external text" href="http://argo.library.okstate.edu/public/RestrictedIPparser.zip">Click here to download.</a>
</li></ul>
<ul><li>	RestrictedIPparser has the following attributes:
</li></ul>
<dl><dd><ul><li>	The program verifies that the addresses in the master file are valid “public” IP addresses and reformats them into IFIP statements.  “Public” in this context means an address is not specified in the RFCs listed at <a rel="nofollow" class="external free" href="http://en.wikipedia.org/wiki/Reserved_IP_addresses">http://en.wikipedia.org/wiki/Reserved_IP_addresses</a> with the exception of address contained in <a class="external mw-magiclink-rfc" rel="nofollow" href="https://tools.ietf.org/html/rfc1918">RFC 1918</a>.  Since many organizations use these “private network” addresses internally, they are considered “public” for the purposes of this application.
</li></ul>
</dd></dl>
<dl><dd><ul><li>	While developing this method, I queried OCLC and learned that when EZproxy is parsing a line in user.txt that line is loaded into a temporary variable that has a limit of 8192 characters. Therefore, the program limits the number of IPs in the IFIP statements to 8150 characters or less (this value also includes the initial 5 characters for “IFIP “) and then appends the default action statement -&#160;; Set Match = “TRUE”.  Optionally the program will accept a user specified action statement up to 40 characters in length in lieu of the default statement.
</li></ul>
</dd></dl>
<dl><dd><ul><li>	The program also adds the Common statements at the beginning and end of the file.
</li></ul>
</dd></dl>
<dl><dd><ul><li>	To allow for some documentation and comments in a master file, the program will skip any line in the master file that begins with the EZproxy comment character (#).   To allow for comments related to a specific IP address, the program will skip any subsequent text on a line after parsing a valid IP.  The program also keeps a log of errors that occur and the number of addresses successfully processed during a run.
</li></ul>
</dd></dl>
<dl><dd><ul><li>	RestrictedIPparser is a command line style program and runs on any version of Windows so it can be used a part of a batch process or scheduled task.  The program only recognizes IPv4 addresses.  I am looking into doing an IPv6 equivalent but it is, at present, a low priority.
</li></ul>
</dd></dl>
<ul><li>	I suspect that other EZproxy sites will construct an equivalent program that incorporates customizations for their environment (e.g. input file format, OS platform, etc.).  I encourage those who can to make their programs available to the EZproxy community.
</li></ul>
<h3> <span class="mw-headline" id="Step_2_.E2.80.93_Add_the_following_statements_to_user.txt_as_indicated_in_the_Notes">Step 2 – Add the following statements to user.txt as indicated in the Notes</span></h3>
<pre>If UserFile (&quot;restrictedIPfilename&quot;) 
If Match eq &quot;True&quot;; Audit whatever_ message_you_want;  Deny denyfile.htm
</pre>
<p>Notes: 
</p>
<ul><li>	The statements must be contained within an authentication block and must be duplicated within each block if you use multiple authentication methods. 
</li></ul>
<ul><li>	Normally the Step 2 statements would be placed prior to any statement containing a STOP command.  E.g.
</li></ul>
<pre>::LDAP
&lt;Statements go here&gt;
BindUser …
BindPass …
URL …

&lt;Or here&gt;

IfUnauthenticated;  Stop
/LDAP
</pre>
<dl><dd>This would log connection attempts regardless if the user successfully authenticated or not.  However, if you only want to log successful authentications from restricted addresses place the Step 2 statements after “IFUnauthenticated”.
</dd></dl>
<ul><li>	If the statements are contained in a Common block that is placed before the authentication blocks in user.txt, the connection attempt will be processed but the user name will not be recorded since the Deny statement would be executed before the login screen is displayed.
</li></ul>
<ul><li>	Theoretically, different action statements or expression structures could be used in place of Deny to provide additional response scenarios however only Deny has been tested.
</li></ul>
<ul><li>	If you vary the structure of the statements in Step 2, thoroughly test the changes. Combining these two statements should be possible however any variation from the listed structure resulted in either an error message or the connection attempt succeeded when it should have failed.
</li></ul>
<ul><li>	Two files were created to test what effect these changes might have on the login process.  One of approximately 80,000 IP addresses acquired from sites listing open proxy servers and second with IP addresses that have been involved is some form of malicious behavior.  Tests were run with each file individually and with both files in the authentication block. E.g.
</li></ul>
<pre>If UserFile (&quot;OpenProxyList.txt&quot;)
If Match eq &quot;True&quot;; Audit whatever_ message_you_want;  Deny denyfile1.htm
If UserFile (&quot;SuspiciousAddresses.txt&quot;)
If Match eq &quot;True&quot;; Audit whatever_ message_you_want;  Deny denyfile2.htm
</pre>
<p>No noticeable degradation in login process was observed in any of the tests and no problem reports related to these changes have been received since implementation in the production server in late December 2013.
</p>
<!-- 
NewPP limit report
Preprocessor visited node count: 37/1000000
Preprocessor generated node count: 104/1000000
Post‐expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key ezpwikidb:pcache:idhash:3436-0!*!*!!en!*!* and timestamp 20150624173444 -->
</div><div class="printfooter">
Retrieved from "<a href="https://pluto.potsdam.edu/ezproxywiki/index.php?title=Restricted_IP_Logging_and_Response&amp;oldid=5155">https://pluto.potsdam.edu/ezproxywiki/index.php?title=Restricted_IP_Logging_and_Response&amp;oldid=5155</a>"</div>
		<div id='catlinks' class='catlinks'><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="Category:Documentation.html" title="Category:Documentation">Documentation</a></li></ul></div></div>		<!-- end content -->
				<div class="visualClear"></div>
	</div>
</div></div>
<div id="column-one">
	<h2>Navigation menu</h2>
	<div id="p-cactions" class="portlet" role="navigation">
		<h3>Views</h3>
		<div class="pBody">
			<ul>
				<li id="ca-nstab-main" class="selected"><a href="Restricted_IP_Logging_and_Response.html" primary="1" context="subject" title="View the content page [c]" accesskey="c">Page</a></li>
				<li id="ca-talk" class="new"><a href="https://pluto.potsdam.edu/ezproxywiki/index.php?title=Talk:Restricted_IP_Logging_and_Response&amp;action=edit&amp;redlink=1" primary="1" context="talk" title="Discussion about the content page [t]" accesskey="t">Discussion</a></li>
				<li id="ca-viewsource"><a href="https://pluto.potsdam.edu/ezproxywiki/index.php?title=Restricted_IP_Logging_and_Response&amp;action=edit" primary="1" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></li>
				<li id="ca-history"><a href="https://pluto.potsdam.edu/ezproxywiki/index.php?title=Restricted_IP_Logging_and_Response&amp;action=history" rel="archives" title="Past revisions of this page [h]" accesskey="h">History</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-personal" role="navigation">
		<h3>Personal tools</h3>
		<div class="pBody">
			<ul>
				<li id="pt-createaccount"><a href="https://pluto.potsdam.edu/ezproxywiki/index.php?title=Special:UserLogin&amp;returnto=Restricted+IP+Logging+and+Response&amp;type=signup">Create account</a></li>
				<li id="pt-login"><a href="https://pluto.potsdam.edu/ezproxywiki/index.php?title=Special:UserLogin&amp;returnto=Restricted+IP+Logging+and+Response" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-logo" role="banner">
<a href="Main_Page.html" style="background-image: url(https://pluto.potsdam.edu/var/www/html/common/dot_trans.gif);" title="Visit the main page"></a>
	</div>
	<div class="generated-sidebar portlet" id="p-navigation" role="navigation">
		<h3>Navigation</h3>
		<div class='pBody'>
			<ul>
				<li id="n-mainpage-description"><a href="Main_Page.html" title="Visit the main page [z]" accesskey="z">Main page</a></li>
				<li id="n-portal"><a href="EZProxyWiki:Community_portal.html" title="About the project, what you can do, where to find things">Community portal</a></li>
				<li id="n-currentevents"><a href="EZProxyWiki:Current_events.html" title="Find background information on current events">Current events</a></li>
				<li id="n-recentchanges"><a href="Special:RecentChanges.html" title="A list of recent changes in the wiki [r]" accesskey="r">Recent changes</a></li>
				<li id="n-randompage"><a href="Special:Random.html" title="Load a random page [x]" accesskey="x">Random page</a></li>
				<li id="n-help"><a href="Help:Contents.html" title="The place to find out">Help</a></li>
			</ul>
		</div>
	</div>
	<div id="p-search" class="portlet" role="search">
		<h3><label for="searchInput">Search</label></h3>
		<div id="searchBody" class="pBody">
			<form action="https://pluto.potsdam.edu/ezproxywiki/index.php" id="searchform">
				<input type='hidden' name="title" value="Special:Search"/>
				<input type="search" name="search" title="Search EZProxyWiki [f]" accesskey="f" id="searchInput" />
				<input type="submit" name="go" value="Go" title="Go to a page with this exact name if exists" id="searchGoButton" class="searchButton" />&#160;
				<input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton" />
			</form>
		</div>
	</div>
	<div class="portlet" id="p-tb" role="navigation">
		<h3>Toolbox</h3>
		<div class="pBody">
			<ul>
				<li id="t-whatlinkshere"><a href="Special:WhatLinksHere/Restricted_IP_Logging_and_Response.html" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
				<li id="t-recentchangeslinked"><a href="Special:RecentChangesLinked/Restricted_IP_Logging_and_Response.html" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
				<li id="t-specialpages"><a href="https://pluto.potsdam.edu/ezproxywiki/index.php/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
				<li id="t-print"><a href="https://pluto.potsdam.edu/ezproxywiki/index.php?title=Restricted_IP_Logging_and_Response&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li>
				<li id="t-permalink"><a href="https://pluto.potsdam.edu/ezproxywiki/index.php?title=Restricted_IP_Logging_and_Response&amp;oldid=5155" title="Permanent link to this revision of the page">Permanent link</a></li>
				<li id="t-info"><a href="https://pluto.potsdam.edu/ezproxywiki/index.php?title=Restricted_IP_Logging_and_Response&amp;action=info">Page information</a></li>
			</ul>
		</div>
	</div>
</div><!-- end of the left (by default at least) column -->
<div class="visualClear"></div>
<div id="footer" role="contentinfo">
	<div id="f-poweredbyico">
		<a href="https://www.mediawiki.org/"><img src="../skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" width="88" height="31" /></a>
	</div>
	<ul id="f-list">
		<li id="lastmod"> This page was last modified on 21 November 2014, at 15:59.</li>
		<li id="viewcount">This page has been accessed 527 times.</li>
		<li id="privacy"><a href="EZProxyWiki:Privacy_policy.html" title="EZProxyWiki:Privacy policy">Privacy policy</a></li>
		<li id="about"><a href="EZProxyWiki:About.html" title="EZProxyWiki:About">About EZProxyWiki</a></li>
		<li id="disclaimer"><a href="EZProxyWiki:General_disclaimer.html" title="EZProxyWiki:General disclaimer">Disclaimers</a></li>
	</ul>
</div>
</div>
<script>if(window.mw){
mw.loader.state({"site":"loading","user":"missing","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.action.view.postEdit","mediawiki.user","mediawiki.page.ready","mediawiki.searchSuggest","mediawiki.hidpi"], null, true);
}</script>
<script>if(window.mw){
mw.loader.state({"site":"ready"});
}</script>
<!-- Served in 0.151 secs. --></body></html>